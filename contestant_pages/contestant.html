<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Contestant Squad</title>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#0f172a; color:#f8fafc; margin:24px; }
    .card{background:#1e293b;border:1px solid #334155;padding:20px;border-radius:10px;max-width:980px;margin:0 auto}
    .back-btn { display:inline-block; margin-bottom:16px; padding:8px 12px; background:#6366f1; color:white; border:none; border-radius:6px; cursor:pointer; text-decoration:none; font-size:0.9rem; }
    .back-btn:hover { background:#4f46e5; }
    h1{margin:0 0 12px 0}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #334155;text-align:left}
    th{color:#94a3b8;text-transform:uppercase;font-size:0.75rem}
    .muted{color:#94a3b8}
    .summary{display:flex;gap:20px;flex-wrap:wrap;margin-top:14px}
    .chip{background:#0f172a;border:1px solid #334155;padding:10px;border-radius:8px}
    .error{color:#f87171;margin-top:12px}
    a.button{display:inline-block;margin-top:12px;padding:8px 12px;background:#6366f1;color:white;border-radius:6px;text-decoration:none}
  </style>
</head>
<body>
  <div class="card">
    <button class="back-btn" onclick="window.close()">← Close Tab</button>
    <h1 id="title">Contestant</h1>
    <div id="meta" class="muted">Loading data...</div>

    <div id="content">
      <div id="msg" class="error" style="display:none"></div>

      <div id="tableWrap" style="display:none">
        <table id="squadTable">
          <thead>
            <tr><th>Player</th><th>Role</th><th>Points</th><th>Price</th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="summary">
          <div class="chip" id="countsChip">Role counts left: —</div>
          <div class="chip" id="pointsChip">Total points: —</div>
          <div class="chip" id="purseChip">Purse left: —</div>
        </div>
      </div>
    </div>

    <div style="margin-top:18px;color:#94a3b8;font-size:0.9rem">This page expects a <code>contestant_data.json</code> file at the project root with per-contestant squads. If the file is not present the page will show instructions.</div>
    <a class="button" href="../index.html" target="_blank">Open Dashboard</a>
  </div>

  <script>
    function getQueryParam(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name);
    }

    const contestantName = getQueryParam('name') || 'Unknown';
    document.getElementById('title').innerText = contestantName;
    document.getElementById('meta').innerText = '';

    // Attempt to load JSON data from parent directory
    const jsonPath = '../contestant_data.json';

    function showMessage(msg){ const el=document.getElementById('msg'); el.style.display='block'; el.innerText=msg; }

    fetch(jsonPath).then(r=>{
      if(!r.ok) throw new Error('Not found');
      return r.json();
    }).then(data=>{
      const entry = data[contestantName];
      if(!entry){ showMessage('No squad data found for "' + contestantName + '" in contestant_data.json'); return; }

      // Expect entry.squad = [{name, role, points, price}, ...]
      const squad = entry.squad || [];
      const tbody = document.querySelector('#squadTable tbody');
      let totalPoints = 0, totalPrice = 0;
      const counts = {Batsman:0,Bowler:0,AR:0,WK:0};

      squad.forEach(p=>{
        const tr = document.createElement('tr');
        const pts = Number(p.points) || 0; const price = Number(p.price) || 0;
        tr.innerHTML = `<td>${p.name}</td><td>${p.role||''}</td><td>${pts.toFixed(1)}</td><td>${price.toFixed(1)}</td>`;
        tbody.appendChild(tr);
        totalPoints += pts; totalPrice += price;

        const role = (p.role||'').toLowerCase();
        if(role.includes('wk')) counts.WK++;
        else if(role.includes('all') || role.includes('ar')) counts.AR++;
        else if(role.includes('bowl')) counts.Bowler++;
        else counts.Batsman++;
      });

      // Assuming each contestant may buy up to 10 of each role
      const maxPerRole = 10;
      const left = {
        Batsman: Math.max(0, maxPerRole - counts.Batsman),
        Bowler: Math.max(0, maxPerRole - counts.Bowler),
        AR: Math.max(0, maxPerRole - counts.AR),
        WK: Math.max(0, maxPerRole - counts.WK)
      };

      document.getElementById('countsChip').innerText = `Left - Batsman: ${left.Batsman}, Bowler: ${left.Bowler}, AR: ${left.AR}, WK: ${left.WK}`;
      document.getElementById('pointsChip').innerText = `Total points: ${totalPoints.toFixed(1)}`;
      const purseLeft = Math.max(0, 200 - totalPrice);
      document.getElementById('purseChip').innerText = `Purse left (from 200): ${purseLeft.toFixed(1)}`;

      document.getElementById('tableWrap').style.display = '';
      document.getElementById('meta').innerText = `${squad.length} players loaded`;
    }).catch(err=>{
      showMessage('contestant_data.json not found or could not be loaded. Please place the Excel file into the project root and run the parsing step so I can generate the JSON.');
      document.getElementById('meta').innerText = 'Data not available';
    });
  </script>
</body>
</html>
